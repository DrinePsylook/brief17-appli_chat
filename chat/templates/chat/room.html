{% extends "chat/base.html" %}
{% load button_components %}

{% block title %}Salle {{ room_name }}{% endblock %}

{% block content %}

<div
    class="flex flex-col h-[80vh] max-w-2xl mx-auto mt-10 bg-white dark:bg-gray-900 rounded-xl shadow-lg overflow-hidden">

    <!-- Titre -->
    <div class="bg-teal-700 text-white py-4 px-6 text-xl font-semibold text-center">
        ðŸ‘‹ Bienvenue dans la salle : {{ room_name }}
    </div>


    <div id="id_chat_item_container" class="flex-1 px-4 py-4 space-y-2 overflow-y-auto bg-green-50 dark:bg-gray-900">
        <!-- Les messages seront ajoutÃ©s ici dynamiquement -->
    </div>

    <div
        class="px-4 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 flex items-center gap-2">
        <input id="chat-message-input" type="text" placeholder="Ã‰cris ton message..."
            class="flex-1 px-4 py-2 rounded-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-teal-500" />
        {% styled_button "Envoyer" "primary" "lg" id="chat-message-submit" %}
    </div>
</div>


{% endblock %}

{% block extra_scripts %}
{{ room_name|json_script:"room-name" }}

<script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const isOwnMessage = data.username === "{{ request.user.username }}";

        const bubbleWrapper = document.createElement("div");
        bubbleWrapper.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`;

        const bubble = document.createElement("div");
        
        bubble.className = `
        px-4 py-2 rounded-lg max-w-[70%] break-words
        ${isOwnMessage
        ? 'bg-cyan-600 text-white rounded-br-none'
        : 'bg-green-500 text-white rounded-bl-none'}
        `;
        bubble.classList.add("transition", "duration-200", "ease-in", "transform", "hover:scale-[1.02]");

        bubble.innerHTML = `<strong>${data.username}</strong><br>${data.message}`;

        bubbleWrapper.appendChild(bubble);
        document.querySelector('#id_chat_item_container').appendChild(bubbleWrapper);

        // scroll auto
        const container = document.querySelector('#id_chat_item_container');
        container.scrollTop = container.scrollHeight;
    };


    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.key === 'Enter') {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        console.log("Sending message:", message);
        chatSocket.send(JSON.stringify({
            'message': message,
            'username': '{{ request.user.username }}'
        }));
        messageInputDom.value = '';
    };
</script>
{% endblock %}